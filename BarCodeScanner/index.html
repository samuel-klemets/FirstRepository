<!DOCTYPE html>
<html>
<head>
    <title>Barcode Scanner with ZXing and Flashlight Toggle</title>
    <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        h1, h2 {
            color: #333;
        }
        video, table {
            border: 4px solid #666;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button, select {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            background-color: #008cba;
            color: white;
            cursor: pointer;
        }
        button:hover, select:hover {
            background-color: #005f73;
        }
        table {
            border-collapse: collapse;
            width: 50%;
        }
        th, td {
            text-align: left;
            padding: 8px;
        }
        tr:nth-child(even) {background-color: #f2f2f2;}
    </style>
</head>
<body>

    <h1>Barcode Scanner</h1>
    <select id="videoInputSelect"></select>
    <video id="video" width="400" height="300"></video>
    <button id="startButton">Start Scanning</button>
    <button id="toggleFlashlight">Toggle Flashlight</button>
    <h2>Scanned Codes</h2>
    <table id="codesTable">
        <tr>
            <th>Scanned Codes</th>
            <th>Scanned X Times</th>
        </tr>
    </table>

    <script>
        let selectedDeviceId;
        const codeReader = new ZXing.BrowserBarcodeReader();
        const scanCounts = new Map(); // Initialize a Map to track scan counts
        let flashlightEnabled = false; // Track the flashlight state
        let videoStream = null; // To store the stream for flashlight control

        console.log('ZXing code reader initialized');

        // Function to update the table
        const updateTable = () => { /* unchanged, see previous script */ };

        // Function to toggle the flashlight
        const toggleFlashlight = async () => {
            if (!videoStream) return; // Do nothing if videoStream is not available

            const track = videoStream.getVideoTracks()[0]; // Get the first video track
            flashlightEnabled = !flashlightEnabled; // Toggle the state

            if (flashlightEnabled) {
                await track.applyConstraints({ advanced: [{torch: true}] });
            } else {
                await track.applyConstraints({ advanced: [{torch: false}] });
            }
        };

        // Device selection and scanner initialization remain unchanged
        codeReader.listVideoInputDevices()
            .then((videoInputDevices) => { /* unchanged, see previous script */ })
            .catch((err) => { console.error(err); });

        document.getElementById('startButton').addEventListener('click', () => { 
            codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                // Unchanged scan result handling
                if (result) {
                    // Unchanged scan result processing
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.error(err);
                }
            }).then(stream => {
                // Save the stream for later to control the flashlight
                videoStream = stream;
            });
            console.log(`Started continuous decode from camera with id ${selectedDeviceId}`);
        });

        // Add event listener for the flashlight toggle button
        document.getElementById('toggleFlashlight').addEventListener('click', toggleFlashlight);
    </script>

</body>
</html>
